<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Aandelenportefeuille</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; margin: 16px; background:#f5f5f5; }
    h1 { font-size: 1.4rem; }
    .card { background:white; padding:12px; margin-bottom:12px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.08); }
    label { display:block; font-size:0.85rem; margin-top:6px; }
    input { width:100%; padding:6px 8px; margin-top:2px; border-radius:4px; border:1px solid #ccc; font-size:0.9rem; box-sizing:border-box; }
    button { margin-top:10px; padding:8px 12px; border:none; border-radius:6px; background:#007aff; color:white; font-size:0.9rem; cursor:pointer; }
    button.secondary { background:#eee; color:#333; margin-left:6px; }
    table { width:100%; border-collapse:collapse; margin-top:8px; font-size:0.8rem; }
    th, td { padding:6px 4px; text-align:right; }
    th:first-child, td:first-child { text-align:left; }
    tr:nth-child(even) { background:#fafafa; }
    .summary { font-weight:bold; margin-top:4px; }
    .gain { color:green; }
    .loss { color:#c00; }
    .search-results { background:white; border:1px solid #ccc; border-radius:6px; margin-top:4px; max-height:200px; overflow-y:auto; }
    .search-item { padding:8px; border-bottom:1px solid #eee; cursor:pointer; }
    .search-item:hover { background:#f0f0f0; }
  </style>
</head>
<body>
  <h1>Mijn Aandelen & ETF portefeuille</h1>

  <!-- ZOEKFUNCTIE -->
  <div class="card">
    <h2>Aandeel / ETF zoeken</h2>
    <label>
      Zoek op naam
      <input type="text" id="searchInput" placeholder="Bijv. ASML, Vanguard, Tesla" />
    </label>
    <div id="searchResults" class="search-results" style="display:none;"></div>
  </div>

  <!-- POSITIE TOEVOEGEN -->
  <div class="card">
    <h2>Positie toevoegen</h2>
    <label>
      Ticker
      <input type="text" id="ticker" placeholder="Bijv. ASML.AS, AAPL" />
    </label>
    <label>
      Aantal stuks
      <input type="number" id="shares" step="1" />
    </label>
    <label>
      Gemiddelde aankoopprijs (in valuta van de ticker)
      <input type="number" id="buyPrice" step="0.01" />
    </label>

    <button id="addPosition">Toevoegen</button>
    <button class="secondary" id="clearAll">Alles wissen</button>
  </div>

  <!-- PORTEFEUILLE -->
  <div class="card">
    <h2>Portefeuille</h2>
    <table>
      <thead>
        <tr>
          <th>Positie</th>
          <th>Stuks</th>
          <th>Gem. aankoop</th>
          <th>Huidige koers</th>
          <th>Inleg</th>
          <th>Waarde</th>
          <th>Resultaat</th>
          <th>%</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="portfolioBody"></tbody>
    </table>
    <p class="summary" id="totalsLine"></p>
  </div>

  <!-- API KEY -->
  <div class="card">
    <h2>API key (alleen voor zoeken)</h2>
    <label>
      Finnhub API key
      <input type="text" id="finnhubKey" placeholder="Finnhub API key" />
    </label>
    <button id="refreshPrices">Koersen verversen</button>
  </div>

<script>
let positions = [];
let fxRatesCache = null;

const TWELVEDATA_KEY = "ad11e6f868624979abc929dd57f36329";

const searchInput = document.getElementById("searchInput");
const searchResults = document.getElementById("searchResults");
const tickerInput = document.getElementById("ticker");
const sharesInput = document.getElementById("shares");
const buyPriceInput = document.getElementById("buyPrice");
const portfolioBody = document.getElementById("portfolioBody");
const totalsLine = document.getElementById("totalsLine");
const finnhubKeyInput = document.getElementById("finnhubKey");

tickerInput.addEventListener("input", () => {
  tickerInput.value = tickerInput.value.toUpperCase();
});

function getCurrencyForTicker(t) {
  t = t.toUpperCase();
  if (t.endsWith(".AS") || t.endsWith(".PA") || t.endsWith(".F") || t.endsWith(".BR")) return "EUR";
  if (t.endsWith(".L")) return "GBP";
  return "USD";
}

function formatCurrency(v, c) {
  const s = { EUR: "€", USD: "$", GBP: "£" };
  return s[c] + " " + v.toFixed(2);
}

async function fetchFxRates(apiKey) {
  if (!apiKey) return {};
  const url = `https://finnhub.io/api/v1/forex/rates?base=EUR&token=${apiKey}`;
  const r = await fetch(url);
  const d = await r.json();
  return d.rates || {};
}

function getFxRate(currency, rates) {
  if (currency === "EUR") return 1;
  if (!rates[currency]) return 1;
  return 1 / rates[currency];
}

async function fetchPrice(ticker) {
  const url = `https://api.twelvedata.com/price?symbol=${ticker}&apikey=${TWELVEDATA_KEY}`;
  const r = await fetch(url);
  const d = await r.json();

  if (!d || !d.price) {
    throw new Error("Geen koersdata");
  }

  return Number(d.price);
}

async function searchFinnhub(query, apiKey) {
  const url = `https://finnhub.io/api/v1/search?q=${query}&token=${apiKey}`;
  const r = await fetch(url);
  const d = await r.json();
  return d.result || [];
}

searchInput.addEventListener("input", async () => {
  const q = searchInput.value.trim();
  const apiKey = finnhubKeyInput.value.trim();

  searchResults.innerHTML = "";
  searchResults.style.display = "none";

  if (q.length < 2) return;
  if (!apiKey) {
    searchResults.innerHTML = "<div class='search-item'>Geen Finnhub API key ingevuld</div>";
    searchResults.style.display = "block";
    return;
  }

  try {
    const results = await searchFinnhub(q, apiKey);

    if (!results.length) {
      searchResults.innerHTML = "<div class='search-item'>Geen resultaten gevonden</div>";
      searchResults.style.display = "block";
      return;
    }

    results.forEach(item => {
      const symbol = item.symbol || item.displaySymbol || "";
      const desc = item.description || symbol;
      const div = document.createElement("div");
      div.className = "search-item";
      div.textContent = `${symbol} — ${desc}`;
      div.onclick = () => {
        tickerInput.value = symbol.toUpperCase();
        searchResults.style.display = "none";
      };
      searchResults.appendChild(div);
    });

    searchResults.style.display = "block";

  } catch (err) {
    searchResults.innerHTML = `<div class='search-item'>Fout: ${err.message}</div>`;
    searchResults.style.display = "block";
  }
});

function render() {
  portfolioBody.innerHTML = "";
  let totalValueEUR = 0;
  let totalInvestedEUR = 0;

  positions.forEach((pos, i) => {
    const invested = pos.shares * pos.buyPrice;
    const value = pos.shares * pos.currentPrice;
    const result = value - invested;
    const pct = invested ? (result / invested) * 100 : 0;

    totalValueEUR += value * pos.fxRate;
    totalInvestedEUR += invested * pos.fxRate;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${pos.ticker}</td>
      <td>${pos.shares}</td>
      <td>${formatCurrency(pos.buyPrice, pos.currency)}</td>
      <td>${formatCurrency(pos.currentPrice, pos.currency)}</td>
      <td>${formatCurrency(invested, pos.currency)}</td>
      <td>${formatCurrency(value, pos.currency)}</td>
      <td class="${result >= 0 ? "gain" : "loss"}">${formatCurrency(result, pos.currency)}</td>
      <td>${pct.toFixed(1)}%</td>
      <td><button class="secondary" data-i="${i}">X</button></td>
    `;
    portfolioBody.appendChild(tr);
  });

  if (!positions.length) {
    totalsLine.textContent = "Geen posities.";
  } else {
    const totalResult = totalValueEUR - totalInvestedEUR;
    const pct = totalInvestedEUR ? (totalResult / totalInvestedEUR) * 100 : 0;
    totalsLine.innerHTML =
      `Totale inleg (EUR): € ${totalInvestedEUR.toFixed(2)} — ` +
      `Totale waarde (EUR): € ${totalValueEUR.toFixed(2)} — ` +
      `Resultaat: <span class="${totalResult >= 0 ? "gain" : "loss"}">€ ${totalResult.toFixed(2)} (${pct.toFixed(1)}%)</span>`;
  }

  document.querySelectorAll("button[data-i]").forEach(btn => {
    btn.onclick = async () => {
      positions.splice(btn.dataset.i, 1);
      save();
      await refreshAllPrices();
      render();
    };
  });
}

function save() {
  localStorage.setItem("pf", JSON.stringify(positions));
  localStorage.setItem("finnhubKey", finnhubKeyInput.value);
}

async function refreshAllPrices() {
  const finnhubKey = finnhubKeyInput.value.trim();
  fxRatesCache = await fetchFxRates(finnhubKey);

  for (const pos of positions) {
    pos.currentPrice = await fetchPrice(pos.ticker);
    pos.fxRate = getFxRate(pos.currency, fxRatesCache);
  }

  save();
}

async function load() {
  positions = JSON.parse(localStorage.getItem("pf") || "[]");
  finnhubKeyInput.value = localStorage.getItem("finnhubKey") || "";

  if (positions.length > 0) {
    await refreshAllPrices();
  }

  render();
}

document.getElementById("addPosition").onclick = async () => {
  const finnhubKey = finnhubKeyInput.value.trim();
  const ticker = tickerInput.value.trim().toUpperCase();
  const shares = Number(sharesInput.value);
  const buyPrice = Number(buyPriceInput.value);

  if (!ticker || shares <= 0 || buyPrice <= 0) {
    alert("Vul alle velden correct in.");
    return;
  }

  let price = 0;
  let fxRate = 1;
  const currency = getCurrencyForTicker(ticker);

  try {
    price = await fetchPrice(ticker);
    if (!fxRatesCache) fxRatesCache = await fetchFxRates(finnhubKey);
    fxRate = getFxRate(currency, fxRatesCache);
  } catch (e) {
    alert("Kon koers niet ophalen: " + e.message);
  }

  positions.push({ ticker, shares, buyPrice, currentPrice: price, currency, fxRate });

  tickerInput.value = "";
  sharesInput.value = "";
  buyPriceInput.value = "";

  save();
  render();
};

document.getElementById("refreshPrices").onclick = async () => {
  await refreshAllPrices();
  render();
};

document.getElementById("clearAll").onclick = () => {
  if (confirm("Alles wissen?")) {
    positions = [];
    save();
    render();
  }
};

load();
</script>

</body>
</html>
